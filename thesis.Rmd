---
title: "Project 2: Master's thesis"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    number_sections: false
---

The project below describes parts of my Master's thesis to obtain my degree in Actuarial Science and Mathematical Finance. The thesis was nominated for the Johan de Witt award for the best actuarial thesis in 2016. 

# Exploratory data analysis

## Data on the Policyholder Level

The data set at hand consists of 163,660 records concerning a Belgian motor thirdparty liability (MTPL hereafter) insurance portfolio. All the observations relate to the year 1997. 

Reading in the data:

```{r, warning = FALSE, error=FALSE, message=FALSE}
library(readr)
MTPL_Data_1997 <- read_delim("MTPL_Data_1997.txt", "\t",
                             escape_double = FALSE, 
                             trim_ws = TRUE, 
                             progress = FALSE)
```

```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(dplyr)
MTPL_Data_1997 <- MTPL_Data_1997 %>%
  select(NCLAIMS, DURATION, AGEPH, AGEC, POWER, SPORT, CODPOSS, TOWN, MAKE) %>%
  mutate(AGEPH = as.numeric(AGEPH))
```


The table below shows the covariates available in the MTPL insurance portfolio. 

```{r, warning = FALSE, fig.margin = TRUE}
knitr::kable(head(MTPL_Data_1997, 8))
```



Create histograms for the variables given above:

```{r, fig.height=3.5, fig.width=11, warning = FALSE, message=FALSE}
library(ggplot2)
library(ggthemes)

AGEPH_hist <- ggplot(data = MTPL_Data_1997, aes(x = AGEPH)) + theme_bw() +
  geom_histogram(aes(y = ..density..), bins = 79, fill = "dodgerblue") +
  geom_line(aes(y=..density..), stat = 'density', colour = "grey50", adjust = 2) +
  scale_x_continuous(breaks = extended_range_breaks()(MTPL_Data_1997$AGEPH)) +
  ylab("Density") + xlab("Age policyholder (years)")

AGEC_hist <- ggplot(data = MTPL_Data_1997, aes(x = AGEC)) + theme_bw() +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "dodgerblue") +
  geom_line(aes(y=..density..), stat = 'density', colour = "grey50", adjust = 2) +
  scale_x_continuous(breaks = extended_range_breaks()(MTPL_Data_1997$AGEC)) +
  ylab("Density") + xlab("Age vehicle (years)")

POWER_hist <- ggplot(data = MTPL_Data_1997, aes(x = POWER)) + theme_bw() +
  geom_histogram(aes(y = ..density..), bins = 70, fill = "dodgerblue") +
  geom_line(aes(y=..density..), stat = 'density', colour = "grey50", adjust = 2) +
  scale_x_continuous(breaks = extended_range_breaks()(MTPL_Data_1997$AGEPH)) +
  ylab("Density") + xlab("Power vehicle (kW)")
```



Plot interactive histograms:

```{r, fig.height=3.5, fig.width=11, warning = FALSE, message=FALSE}
library(plotly)
ggplotly(AGEPH_hist)
ggplotly(AGEC_hist)
ggplotly(POWER_hist)
```

The next step is to explorate the number of claims per municipality. To obtain better insights in the overall geographic patterns of the claim frequency in Belgium, choropleth maps are used. A choropleth map is a thematic map in which areas are shaded or patterned in proportion to the measurements of the statistical variable being displayed on the map. It is observed that in the Brussels-Capital Region many municipalities exist with higher ratios compared to the nation-wide average.

```{r}
nclaims_per_codposs <- MTPL_Data_1997 %>%
  group_by(CODPOSS) %>%
  summarize(NCLAIMS = sum(NCLAIMS), EXP = n()) %>%
  mutate(CLAIM_RATIO = round(NCLAIMS / EXP, 3))

knitr::kable(head(nclaims_per_codposs, 6))
#stop
```
The spatial object on the municipality level is obtained from the Global Administrative Areas (GADM) database (http://www.gadm.org).

```{r, message = FALSE, error = FALSE, warning = FALSE}
library(RColorBrewer)
library(classInt)
library(ggmap)

RedYellowGreen7 <- rev(brewer.pal(7, 'RdYlGn'))
Blues7 <- brewer.pal(7, 'Blues')

#fisher jenks breaks function
fisher7 <- function(data){
  classIntervals(data, n=7, style='fisher', intervalClosure='right')[[2]]
}

#transparent legend
transparent_legend =  theme(
  legend.background = element_rect(fill = "transparent"),
  legend.key = element_rect(fill = "transparent", color = "transparent")
)

#function to plot maps
map_belgium_disc <- function(data, mapping, naam, palette) {
  ggplot(data, aes(x = long, y = lat, group = group)) + #data should be object produced by fortify function
    geom_polygon(mapping) + #choose which categorized variable should be plotted
    scale_fill_manual(name = naam, values = palette) +
    coord_map() + #uses Mercator projection as default
    theme_nothing(legend = TRUE) +  #to get rid of everything
    theme(legend.justification = c(0,0), legend.position = c(0,0)) + #put legend in left corner
    guides(fill = guide_legend(reverse = TRUE)) + #reverse legend colors
    transparent_legend
}

belgie_fortify <- readRDS("belgie_fortify.rds")
finaldata00 <- readRDS("finaldata.rds") #combination of data frames: inwoners, inkomen, data1997, zipcodes and verkeer
belgieDat <- readRDS("belgieDat.rds")
finaldata <- finaldata00 %>% left_join(., belgieDat) %>% arrange(ID_4)

#add both vectors to the original data set 
finaldata0 <- finaldata %>% 
  mutate(RATIO.NCLAIMS.EXP.cut = cut(RATIO.NCLAIMS.EXP, breaks = fisher7(RATIO.NCLAIMS.EXP), include.lowest = TRUE)) %>% 
  mutate(NCLAIMS.cut = cut(NCLAIMS, breaks = fisher7(NCLAIMS), include.lowest = TRUE)) %>%
  mutate(EXP.cut = cut(EXP, breaks = fisher7(EXP), include.lowest = TRUE, dig.lab = 4)) 

#merge this with shapefile to plot the map
belgie_fortify0 <- left_join(belgie_fortify, finaldata0)

#plot ratio 
ratio.map <- map_belgium_disc(belgie_fortify0, aes(fill = RATIO.NCLAIMS.EXP.cut), "Ratio", palette = Blues7)
ggplotly(ratio.map)
```

