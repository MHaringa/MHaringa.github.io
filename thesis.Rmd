---
title: "Project 2: Master's thesis"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    number_sections: false
---

The project below describes parts of my Master's thesis to obtain my degree in Actuarial Science and Mathematical Finance. The thesis was nominated for the Johan de Witt award for best actuarial thesis in 2016. 

# Introduction

Learning practical data science (as opposed to theoretical, academic topics) requires the ability to take a dataset, wrangle it into shape, and use visualization techniques to find insights. Therefore it is essential to obtain a solid foundation in two core skill areas:

- Data manipulation;
- Data visualization.

In practical terms, this means that as an R user, you should know <tt>ggplot2</tt> and <tt>dplyr</tt>. Also learning a few other parts of the tidyverse, like <tt>tidyr</tt>, and <tt>lubridate</tt>, is recommended. The <tt>tidyverse</tt> is a set of packages that work in harmony because they share common data representations. It is powerful for wrangling, visualizing, and analyzing data. 

This project shows how these two core skills are applied to a large motor insurance portfolio from a Belgian non-life insurer. It contains parts of my master's thesis. 

First things first: we need to get the data and hammer it into shape.

# Data and Inputs

First, we need to get the data. Import it using the readr package:

```{r, warning = FALSE, error=FALSE, message=FALSE}
library(readr)
mtpl_data_1997 <- read_delim("mtpl_data_1997.txt", "\t",
                             escape_double = FALSE, 
                             trim_ws = TRUE, 
                             progress = FALSE)
```

```{r, echo = FALSE, warning = FALSE, message=FALSE}
library(dplyr)
mtpl_data_1997 <- mtpl_data_1997 %>%
  select(NCLAIMS, DURATION, AGEPH, AGEC, POWER, SPORT, CODPOSS, TOWN, MAKE) %>%
  mutate(AGEPH = as.numeric(AGEPH))
```

After reading in the data, we'll examine the data using glimpse(). 

This will give us the names of the columns, the dimensions of the data, and will print out the first several observations. It is important to routinely examine your data after you change it. Essentially, as you execute a procedure, you want to make sure that the procedure did what you wanted it to. 

```{r, warning = FALSE, fig.margin = TRUE}
# INSPECT 
glimpse(mtpl_data_1997)
```

The data set at hand consists of 163,660 records concerning a Belgian motor thirdparty liability (MTPL hereafter) insurance portfolio. All the observations relate to the year 1997. 

## Rename variables

Next, we're going to rename our variables by transforming them all to lower case. In programming, there are several different style conventions, but many people will tell you that there's no good reason to have a capitalized first letter for a variable name. In most situations, you'll want to remove capitals, if for no other reason than it makes them easier to type. 

To execute this, we're going to use colnames() and tolower(). Here, we're using the pipe operator (%>%) to 'pipe' the names into tolower(). The pipe operator can be read as 'and then'. 

```{r}
#LOWER CASE
colnames(mtpl_data_1997) <- colnames(mtpl_data_1997) %>% tolower()

#INSPECT
colnames(mtpl_data_1997)
```


# Exploratory Data Analyses

To explore the data we create histograms and choropleth maps. 

## Create histograms

To obtain insights in the distribution of the data on the policyholder's level, histograms are created  for the age of the policyholder, age of the vehicle, and power of the vehicle, using the *ggplot2* library in R. 

```{r, fig.height=3.5, fig.width=11, warning = FALSE, message=FALSE}
# LOAD LIBRARIES
library(ggplot2)
library(ggthemes)

# CREATE HISTOGRAMS
ageph_histogram <- ggplot(data = mtpl_data_1997, aes(x = ageph)) + 
  geom_histogram(aes(y = ..density..), bins = 79, fill = "dodgerblue") +
  scale_x_continuous(breaks = extended_range_breaks()(mtpl_data_1997$ageph)) +
  ylab("Density") + xlab("Age policyholder (years)") + 
  theme_bw() #theme with a white background

agec_histogram <- ggplot(data = mtpl_data_1997, aes(x = agec)) + 
  geom_histogram(aes(y = ..density..), bins = 50, fill = "dodgerblue") +
  scale_x_continuous(breaks = extended_range_breaks()(mtpl_data_1997$agec)) +
  ylab("Density") + xlab("Age vehicle (years)") + theme_bw() 

power_histogram <- ggplot(data = mtpl_data_1997, aes(x = power)) +
  geom_histogram(aes(y = ..density..), bins = 70, fill = "dodgerblue") +
  scale_x_continuous(breaks = extended_range_breaks()(mtpl_data_1997$ageph)) +
  ylab("Density") + xlab("Power vehicle (kW)") + theme_bw()
```

Use ggplot2 with plotly to obtain interactive ggplot2 charts:

```{r, fig.height=3.5, fig.width=11, warning = FALSE, message=FALSE}
# LOAD LIBRARY
library(plotly)

# CREATE INTERACTIVE GGPLOT2 CHARTS
ggplotly(ageph_histogram)
ggplotly(agec_histogram)
ggplotly(power_histogram)
```

## Choropleth maps

To obtain better insights in the overall geographic patterns of the number of claims per municipality in Belgium, choropleth maps are used. A choropleth map is a thematic map in which areas are shaded or patterned in proportion to the measurements of the statistical variable being displayed on the map. 

```{r}
# LOAD LIBRARY
library(dplyr)

# SUMMARIZE NUMBER OF CLAIMS AND EXPOSURE PER POSTAL CODE
nclaims_per_codposs <- mtpl_data_1997 %>%
  group_by(codposs) %>%
  summarize(nclaims = sum(nclaims), exposure = n()) %>%
  mutate(claim_ratio = round(nclaims / exposure, 3))

#INSPECT
glimpse(nclaims_per_codposs)
```

The spatial object on the municipality level is obtained from the Global Administrative Areas (GADM) database (http://www.gadm.org) in a R (SpatialPolygonsDataFrame) format.

```{r, message = FALSE, warning = FALSE, eval = FALSE}
#install.packages("gpclib", type = "source")
library(gpclib)
library(rgeos)
gpclibPermit() #turn on the license
belgium_shapefile <- readRDS("BEL_adm4.rds") #load shapefile
belgie_fortify0 <- fortify(belgium_shapefile, region = "NAME_4") 
```


Make sure to remove all unwanted characters. 

```{r, eval = FALSE}
library(gsubfn)

#LIST OF UNWANTED PUNCTUATION MARKS
unwanted_array <- list('Š'='S', 'š'='s', 'Ž'='Z', 'ž'='z', 'À'='A', 'Á'='A', 'Â'='A', 
                       'Ã'='A', 'Ä'='A', 'Å'='A', 'Æ'='A', 'Ç'='C', 'È'='E', 'É'='E',
                       'Ê'='E', 'Ë'='E', 'Ì'='I', 'Í'='I', 'Î'='I', 'Ï'='I', 'Ñ'='N', 
                       'Ò'='O', 'Ó'='O', 'Ô'='O', 'Õ'='O', 'Ö'='O', 'Ø'='O', 'Ù'='U',
                       'Ú'='U', 'Û'='U', 'Ü'='U', 'Ý'='Y', 'Þ'='B', 'ß'='Ss','à'='a', 
                       'á'='a', 'â'='a', 'ã'='a', 'ä'='a', 'å'='a', 'æ'='a', 'ç'='c',
                       'è'='e', 'é'='e', 'ê'='e', 'ë'='e', 'ì'='i', 'í'='i', 'î'='i', 
                       'ï'='i', 'ð'='o', 'ñ'='n', 'ò'='o', 'ó'='o', 'ô'='o', 'õ'='o',
                       'ö'='o', 'ø'='o', 'ù'='u', 'ú'='u', 'û'='u', 'ý'='y', 'ý'='y', 
                       'þ'='b', 'ÿ'='y')

#ELIMINATING PUNCTUATION MARKS IN MUNICIPALITY NAMES
belgie_fortify <- belgie_fortify0 %>% 
  mutate(id = gsubfn(paste(names(unwanted_array), collapse = '|'), unwanted_array, toupper(id))) 

```

```{r, eval = TRUE, echo = FALSE, warning = FALSE, message = FALSE}
belgie_fortify <- readRDS("belgie_fortify.rds")
```

```{r, message = FALSE, error = FALSE, warning = FALSE, eval = TRUE}
library(RColorBrewer)
library(classInt)
library(ggmap)

RedYellowGreen7 <- rev(brewer.pal(7, 'RdYlGn'))
Blues7 <- brewer.pal(7, 'Blues')

#fisher jenks breaks function
fisher7 <- function(data){
  classIntervals(data, n=7, style='fisher', intervalClosure='right')[[2]]
}

#transparent legend
transparent_legend =  theme(
  legend.background = element_rect(fill = "transparent"),
  legend.key = element_rect(fill = "transparent", color = "transparent")
)

#function to plot maps
map_belgium_disc <- function(data, mapping, naam, palette) {
  ggplot(data, aes(x = long, y = lat, group = group)) + #data should be object produced by fortify function
    geom_polygon(mapping) + #choose which categorized variable should be plotted
    scale_fill_manual(name = naam, values = palette) +
    coord_map() + #uses Mercator projection as default
    theme_nothing(legend = TRUE) +  #to get rid of everything
    theme(legend.justification = c(0,0), legend.position = c(0,0)) + #put legend in left corner
    guides(fill = guide_legend(reverse = TRUE)) + #reverse legend colors
    transparent_legend
}

```

The above functions are used:

```{r}
finaldata00 <- readRDS("finaldata.rds") #combination of data frames: inwoners, inkomen, data1997, zipcodes and verkeer
belgieDat <- readRDS("belgieDat.rds")
finaldata <- finaldata00 %>% 
  left_join(., belgieDat) %>% 
  arrange(ID_4)

colnames(finaldata) <- colnames(finaldata) %>% tolower()

glimpse(finaldata)
```

Now the functions are used:
```{r}
#add both vectors to the original data set 
finaldata0 <- finaldata %>% 
  mutate(ratio.nclaims.exp.cut = cut(ratio.nclaims.exp, 
                                     breaks = fisher7(ratio.nclaims.exp), 
                                     include.lowest = TRUE)) %>% 
  mutate(nclaims.cut = cut(nclaims, breaks = fisher7(nclaims), include.lowest = TRUE)) %>%
  mutate(exp.cut = cut(exp, breaks = fisher7(exp), include.lowest = TRUE, dig.lab = 4)) 

colnames(finaldata0) <- colnames(finaldata0) %>% tolower()

colnames(belgie_fortify) <- colnames(belgie_fortify) %>% tolower()

#merge this with shapefile to plot the map
belgie_fortify0 <- left_join(belgie_fortify, finaldata0)
library(plotly)

ratio.map <- map_belgium_disc(belgie_fortify0, aes(fill = ratio.nclaims.exp.cut), "Ratio", palette = Blues7)
ratio.map

```

It is observed that in the Brussels-Capital Region many municipalities exist with higher ratios compared to the nation-wide average.